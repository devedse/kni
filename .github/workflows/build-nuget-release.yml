name: Build and Release NuGet Packages

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag for the release (e.g., v1.0.0)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false

jobs:
  build-linux:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x
    
    - name: Install NuGet CLI
      run: |
        sudo apt-get update
        sudo apt-get install -y mono-complete
        wget https://dist.nuget.org/win-x86-commandline/latest/nuget.exe
        sudo mv nuget.exe /usr/local/bin/nuget.exe
        echo 'mono /usr/local/bin/nuget.exe "$@"' | sudo tee /usr/local/bin/nuget
        sudo chmod +x /usr/local/bin/nuget
    
    - name: Install workloads for Android
      run: dotnet workload install android
    
    - name: Install workloads for Blazor
      run: dotnet workload install wasm-tools
    
    - name: Install Android SDK dependencies for Android.GL
      run: dotnet build Platforms/Kni.Platform.Android.GL.csproj -t:InstallAndroidDependencies -f net8.0-android -p:AcceptAndroidSDKLicenses=true
    
    - name: Install Android SDK dependencies for Oculus.GL
      run: dotnet build Platforms/Kni.Platform.Oculus.GL.csproj -t:InstallAndroidDependencies -f net8.0-android32.0 -p:AcceptAndroidSDKLicenses=true
    
    - name: Install Android SDK dependencies for Cardboard.GL
      run: dotnet build Platforms/Kni.Platform.Cardboard.GL.csproj -t:InstallAndroidDependencies -f net8.0-android30 -p:AcceptAndroidSDKLicenses=true
    
    - name: Restore MGCB tool for net8.0 only
      run: dotnet restore Tools/MonoGame.Content.Builder/MGCB.csproj /p:TargetFramework=net8.0 /p:Platform=AnyCPU
    
    - name: Build MGCB tool for Content.Pipeline.Builder packages
      run: dotnet build Tools/MonoGame.Content.Builder/MGCB.csproj -c Release -f net8.0 /p:Platform=AnyCPU --no-restore
    
    - name: Create output directory
      run: mkdir -p NuGetPackages/Output
    
    - name: Pack Xna.Framework
      run: dotnet pack src/Xna.Framework/Xna.Framework.csproj --output NuGetPackages/Output/ /t:Build /p:Configuration=Release /p:Version=${{ inputs.version }}
    
    - name: Pack Xna.Framework.Content
      run: dotnet pack src/Xna.Framework.Content/Xna.Framework.Content.csproj --output NuGetPackages/Output/ /t:Build /p:Configuration=Release /p:Version=${{ inputs.version }}
    
    - name: Pack Xna.Framework.Graphics
      run: dotnet pack src/Xna.Framework.Graphics/Xna.Framework.Graphics.csproj --output NuGetPackages/Output/ /t:Build /p:Configuration=Release /p:Version=${{ inputs.version }}
    
    - name: Pack Xna.Framework.Audio
      run: dotnet pack src/Xna.Framework.Audio/Xna.Framework.Audio.csproj --output NuGetPackages/Output/ /t:Build /p:Configuration=Release /p:Version=${{ inputs.version }}
    
    - name: Pack Xna.Framework.Media
      run: dotnet pack src/Xna.Framework.Media/XNA.Framework.Media.csproj --output NuGetPackages/Output/ /t:Build /p:Configuration=Release /p:Version=${{ inputs.version }}
    
    - name: Pack Xna.Framework.Input
      run: dotnet pack src/Xna.Framework.Input/Xna.Framework.Input.csproj --output NuGetPackages/Output/ /t:Build /p:Configuration=Release /p:Version=${{ inputs.version }}
    
    - name: Pack Xna.Framework.Game
      run: dotnet pack src/Xna.Framework.Game/Xna.Framework.Game.csproj --output NuGetPackages/Output/ /t:Build /p:Configuration=Release /p:Version=${{ inputs.version }}
    
    - name: Pack Xna.Framework.Devices
      run: dotnet pack src/Xna.Framework.Devices/Xna.Framework.Devices.csproj --output NuGetPackages/Output/ /t:Build /p:Configuration=Release /p:Version=${{ inputs.version }}
    
    - name: Pack Xna.Framework.Storage
      run: dotnet pack src/Xna.Framework.Storage/Xna.Framework.Storage.csproj --output NuGetPackages/Output/ /t:Build /p:Configuration=Release /p:Version=${{ inputs.version }}
    
    - name: Pack Xna.Framework.XR
      run: dotnet pack src/Xna.Framework.XR/Xna.Framework.XR.csproj --output NuGetPackages/Output/ /t:Build /p:Configuration=Release /p:Version=${{ inputs.version }}
    
    - name: Pack Xna.Framework.Design
      run: dotnet pack src/Xna.Framework.Design/Xna.Framework.Design.csproj --output NuGetPackages/Output/ /t:Build /p:Configuration=Release /p:Version=${{ inputs.version }}
    
    - name: Pack Xna.Framework.Content.Pipeline
      run: dotnet pack src/Xna.Framework.Content.Pipeline/XNA.Framework.Content.Pipeline.csproj --output NuGetPackages/Output/ /t:Build /p:Configuration=Release /p:Version=${{ inputs.version }}
    
    - name: Pack Xna.Framework.Content.Pipeline.Audio
      run: dotnet pack src/Xna.Framework.Content.Pipeline.Audio/XNA.Framework.Content.Pipeline.Audio.csproj --output NuGetPackages/Output/ /t:Build /p:Configuration=Release /p:Version=${{ inputs.version }}
    
    - name: Pack Xna.Framework.Content.Pipeline.Graphics
      run: dotnet pack src/Xna.Framework.Content.Pipeline.Graphics/XNA.Framework.Content.Pipeline.Graphics.csproj --output NuGetPackages/Output/ /t:Build /p:Configuration=Release /p:Version=${{ inputs.version }}
    
    - name: Pack Xna.Framework.Content.Pipeline.Media
      run: dotnet pack src/Xna.Framework.Content.Pipeline.Media/XNA.Framework.Content.Pipeline.Media.csproj --output NuGetPackages/Output/ /t:Build /p:Configuration=Release /p:Version=${{ inputs.version }}
    
    - name: Pack Kni.Platform.Android.GL
      run: dotnet pack Platforms/Kni.Platform.Android.GL.csproj --output NuGetPackages/Output/ /t:Build /p:Configuration=Release /p:Version=${{ inputs.version }}
    
    - name: Pack Kni.Platform.SDL2.GL
      run: dotnet pack Platforms/Kni.Platform.SDL2.GL.csproj --output NuGetPackages/Output/ /t:Build /p:Configuration=Release /p:Version=${{ inputs.version }}
    
    - name: Pack Kni.Platform.Blazor.GL
      run: dotnet pack Kni.Platform.Blazor.GL.sln --output NuGetPackages/Output/ /t:Build /p:Configuration=Release /p:Version=${{ inputs.version }}
    
    - name: Pack Kni.Platform.Ref
      run: dotnet pack Platforms/Kni.Platform.Ref.csproj --output NuGetPackages/Output/ /t:Build /p:Configuration=Release /p:Version=${{ inputs.version }}
    
    - name: Pack Kni.Platform.Oculus.GL
      run: dotnet pack Platforms/Kni.Platform.Oculus.GL.csproj --output NuGetPackages/Output/ /t:Build /p:Configuration=Release /p:Version=${{ inputs.version }}
    
    - name: Pack Kni.Platform.Cardboard.GL
      run: dotnet pack Platforms/Kni.Platform.Cardboard.GL.csproj --output NuGetPackages/Output/ /t:Build /p:Configuration=Release /p:Version=${{ inputs.version }}
    
    # Windows-only packages - cannot build on Linux
    # - name: Pack Kni.Platform.WinForms.DX11
    #   run: dotnet pack Platforms/Kni.Platform.WinForms.DX11.csproj --output NuGetPackages/Output/ /t:Build /p:Configuration=Release
    
    # - name: Pack Kni.Platform.WinForms.DX11.OculusOVR
    #   run: dotnet pack Platforms/Kni.Platform.WinForms.DX11.OculusOVR.csproj --output NuGetPackages/Output/ /t:Build /p:Configuration=Release
    
    - name: Pack Content.Pipeline.Builder
      run: nuget pack NuGetPackages/Content.Pipeline.Builder.nuspec -OutputDirectory NuGetPackages/Output/ -BasePath . -Version ${{ inputs.version }} -Properties Configuration=Release
    
    # Windows-only nuspec packages - require net8.0-windows and UWP builds
    # - name: Pack Content.Pipeline.Builder.Windows
    #   run: nuget pack NuGetPackages/Content.Pipeline.Builder.Windows.nuspec -OutputDirectory NuGetPackages/Output/ -BasePath . -Version ${{ inputs.version }} -Properties Configuration=Release
    
    # - name: Pack MonoGame.Framework.WindowsUniversal
    #   run: nuget pack NuGetPackages/MonoGame.Framework.WindowsUniversal.nuspec -OutputDirectory NuGetPackages/Output/ -BasePath . -Version ${{ inputs.version }} -Properties Configuration=Release
    
    - name: List generated packages
      run: ls -la NuGetPackages/Output/
    
    - name: Upload NuGet packages as artifacts
      uses: actions/upload-artifact@v4
      with:
        name: nuget-packages-linux
        path: NuGetPackages/Output/*.nupkg
        retention-days: 90

  build-macos:
    runs-on: macos-latest
    permissions:
      contents: write
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x
    
    - name: Install workloads for iOS
      run: dotnet workload install ios
    
    - name: Create output directory
      run: mkdir -p NuGetPackages/Output
    
    - name: Pack Kni.Platform.iOS.GL
      run: dotnet pack Platforms/Kni.Platform.iOS.GL.csproj --output NuGetPackages/Output/ /t:Build /p:Configuration=Release /p:Version=${{ inputs.version }}
    
    - name: List generated packages
      run: ls -la NuGetPackages/Output/
    
    - name: Upload NuGet packages as artifacts
      uses: actions/upload-artifact@v4
      with:
        name: nuget-packages-macos
        path: NuGetPackages/Output/*.nupkg
        retention-days: 90

  build-windows:
    runs-on: windows-latest
    permissions:
      contents: write
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x
    
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
    
    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2
    
    - name: Install workloads for Android
      run: dotnet workload install android
    
    - name: Install workloads for iOS
      run: dotnet workload install ios
    
    - name: Install workloads for Blazor
      run: dotnet workload install wasm-tools
    
    - name: Install Android SDK dependencies for Android.GL
      run: dotnet build Platforms/Kni.Platform.Android.GL.csproj -t:InstallAndroidDependencies -f net8.0-android -p:AcceptAndroidSDKLicenses=true
    
    - name: Install Android SDK dependencies for Oculus.GL
      run: dotnet build Platforms/Kni.Platform.Oculus.GL.csproj -t:InstallAndroidDependencies -f net8.0-android32.0 -p:AcceptAndroidSDKLicenses=true
    
    - name: Install Android SDK dependencies for Cardboard.GL
      run: dotnet build Platforms/Kni.Platform.Cardboard.GL.csproj -t:InstallAndroidDependencies -f net8.0-android30 -p:AcceptAndroidSDKLicenses=true
    
    - name: Build MGCB tool for Content.Pipeline.Builder packages
      run: dotnet build Tools/MonoGame.Content.Builder/MGCB.csproj -c Release /p:Platform=AnyCPU
    
    - name: Build Kni.Platform.UAP.DX11 for WindowsUniversal nuspec
      run: msbuild Platforms/Kni.Platform.UAP.DX11.csproj /p:Configuration=Release /p:Platform=AnyCPU /restore
    
    - name: Create output directory
      run: New-Item -ItemType Directory -Force -Path NuGetPackages/Output
    
    - name: Pack Xna.Framework
      run: dotnet pack src/Xna.Framework/Xna.Framework.csproj --output NuGetPackages/Output/ /t:Build /p:Configuration=Release /p:Version=${{ inputs.version }}
    
    - name: Pack Xna.Framework.Content
      run: dotnet pack src/Xna.Framework.Content/Xna.Framework.Content.csproj --output NuGetPackages/Output/ /t:Build /p:Configuration=Release /p:Version=${{ inputs.version }}
    
    - name: Pack Xna.Framework.Graphics
      run: dotnet pack src/Xna.Framework.Graphics/Xna.Framework.Graphics.csproj --output NuGetPackages/Output/ /t:Build /p:Configuration=Release /p:Version=${{ inputs.version }}
    
    - name: Pack Xna.Framework.Audio
      run: dotnet pack src/Xna.Framework.Audio/Xna.Framework.Audio.csproj --output NuGetPackages/Output/ /t:Build /p:Configuration=Release /p:Version=${{ inputs.version }}
    
    - name: Pack Xna.Framework.Media
      run: dotnet pack src/Xna.Framework.Media/XNA.Framework.Media.csproj --output NuGetPackages/Output/ /t:Build /p:Configuration=Release /p:Version=${{ inputs.version }}
    
    - name: Pack Xna.Framework.Input
      run: dotnet pack src/Xna.Framework.Input/Xna.Framework.Input.csproj --output NuGetPackages/Output/ /t:Build /p:Configuration=Release /p:Version=${{ inputs.version }}
    
    - name: Pack Xna.Framework.Game
      run: dotnet pack src/Xna.Framework.Game/Xna.Framework.Game.csproj --output NuGetPackages/Output/ /t:Build /p:Configuration=Release /p:Version=${{ inputs.version }}
    
    - name: Pack Xna.Framework.Devices
      run: dotnet pack src/Xna.Framework.Devices/Xna.Framework.Devices.csproj --output NuGetPackages/Output/ /t:Build /p:Configuration=Release /p:Version=${{ inputs.version }}
    
    - name: Pack Xna.Framework.Storage
      run: dotnet pack src/Xna.Framework.Storage/Xna.Framework.Storage.csproj --output NuGetPackages/Output/ /t:Build /p:Configuration=Release /p:Version=${{ inputs.version }}
    
    - name: Pack Xna.Framework.XR
      run: dotnet pack src/Xna.Framework.XR/Xna.Framework.XR.csproj --output NuGetPackages/Output/ /t:Build /p:Configuration=Release /p:Version=${{ inputs.version }}
    
    - name: Pack Xna.Framework.Design
      run: dotnet pack src/Xna.Framework.Design/Xna.Framework.Design.csproj --output NuGetPackages/Output/ /t:Build /p:Configuration=Release /p:Version=${{ inputs.version }}
    
    - name: Pack Xna.Framework.Content.Pipeline
      run: dotnet pack src/Xna.Framework.Content.Pipeline/XNA.Framework.Content.Pipeline.csproj --output NuGetPackages/Output/ /t:Build /p:Configuration=Release /p:Version=${{ inputs.version }}
    
    - name: Pack Xna.Framework.Content.Pipeline.Audio
      run: dotnet pack src/Xna.Framework.Content.Pipeline.Audio/XNA.Framework.Content.Pipeline.Audio.csproj --output NuGetPackages/Output/ /t:Build /p:Configuration=Release /p:Version=${{ inputs.version }}
    
    - name: Pack Xna.Framework.Content.Pipeline.Graphics
      run: dotnet pack src/Xna.Framework.Content.Pipeline.Graphics/XNA.Framework.Content.Pipeline.Graphics.csproj --output NuGetPackages/Output/ /t:Build /p:Configuration=Release /p:Version=${{ inputs.version }}
    
    - name: Pack Xna.Framework.Content.Pipeline.Media
      run: dotnet pack src/Xna.Framework.Content.Pipeline.Media/XNA.Framework.Content.Pipeline.Media.csproj --output NuGetPackages/Output/ /t:Build /p:Configuration=Release /p:Version=${{ inputs.version }}
    
    - name: Pack Kni.Platform.Android.GL
      run: dotnet pack Platforms/Kni.Platform.Android.GL.csproj --output NuGetPackages/Output/ /t:Build /p:Configuration=Release /p:Version=${{ inputs.version }}
    
    - name: Pack Kni.Platform.iOS.GL
      run: dotnet pack Platforms/Kni.Platform.iOS.GL.csproj --output NuGetPackages/Output/ /t:Build /p:Configuration=Release /p:Version=${{ inputs.version }}
    
    - name: Pack Kni.Platform.SDL2.GL
      run: dotnet pack Platforms/Kni.Platform.SDL2.GL.csproj --output NuGetPackages/Output/ /t:Build /p:Configuration=Release /p:Version=${{ inputs.version }}
    
    - name: Pack Kni.Platform.Blazor.GL
      run: dotnet pack Kni.Platform.Blazor.GL.sln --output NuGetPackages/Output/ /t:Build /p:Configuration=Release /p:Version=${{ inputs.version }}
    
    - name: Pack Kni.Platform.Ref
      run: dotnet pack Platforms/Kni.Platform.Ref.csproj --output NuGetPackages/Output/ /t:Build /p:Configuration=Release /p:Version=${{ inputs.version }}
    
    - name: Pack Kni.Platform.Oculus.GL
      run: dotnet pack Platforms/Kni.Platform.Oculus.GL.csproj --output NuGetPackages/Output/ /t:Build /p:Configuration=Release /p:Version=${{ inputs.version }}
    
    - name: Pack Kni.Platform.Cardboard.GL
      run: dotnet pack Platforms/Kni.Platform.Cardboard.GL.csproj --output NuGetPackages/Output/ /t:Build /p:Configuration=Release /p:Version=${{ inputs.version }}
    
    - name: Pack Kni.Platform.WinForms.DX11
      run: dotnet pack Platforms/Kni.Platform.WinForms.DX11.csproj --output NuGetPackages/Output/ /t:Build /p:Configuration=Release /p:Version=${{ inputs.version }}
    
    - name: Pack Kni.Platform.WinForms.DX11.OculusOVR
      run: dotnet pack Platforms/Kni.Platform.WinForms.DX11.OculusOVR.csproj --output NuGetPackages/Output/ /t:Build /p:Configuration=Release /p:Version=${{ inputs.version }}
    
    - name: Pack Content.Pipeline.Builder
      run: nuget pack NuGetPackages/Content.Pipeline.Builder.nuspec -OutputDirectory NuGetPackages/Output/ -BasePath . -Version ${{ inputs.version }} -Properties Configuration=Release
    
    - name: Pack Content.Pipeline.Builder.Windows
      run: nuget pack NuGetPackages/Content.Pipeline.Builder.Windows.nuspec -OutputDirectory NuGetPackages/Output/ -BasePath . -Version ${{ inputs.version }} -Properties Configuration=Release
    
    - name: Pack MonoGame.Framework.WindowsUniversal
      run: nuget pack NuGetPackages/MonoGame.Framework.WindowsUniversal.nuspec -OutputDirectory NuGetPackages/Output/ -BasePath . -Version ${{ inputs.version }} -Properties Configuration=Release
    
    - name: List generated packages
      run: Get-ChildItem -Path NuGetPackages/Output/ -Recurse
    
    - name: Upload NuGet packages as artifacts
      uses: actions/upload-artifact@v4
      with:
        name: nuget-packages-windows
        path: NuGetPackages/Output/*.nupkg
        retention-days: 90
  
#   release:
#     needs: [build-linux, build-macos, build-windows]
#     runs-on: ubuntu-latest
#     permissions:
#       contents: write
    
#     steps:
#     - name: Download Linux NuGet packages
#       uses: actions/download-artifact@v4
#       with:
#         name: nuget-packages-linux
#         path: packages
    
#     - name: Download macOS NuGet packages
#       uses: actions/download-artifact@v4
#       with:
#         name: nuget-packages-macos
#         path: packages
    
#     - name: Download Windows NuGet packages
#       uses: actions/download-artifact@v4
#       with:
#         name: nuget-packages-windows
#         path: packages
    
#     - name: Create GitHub Release
#       uses: softprops/action-gh-release@v1
#       with:
#         tag_name: ${{ inputs.version }}
#         name: Release ${{ inputs.version }}
#         draft: false
#         prerelease: ${{ inputs.prerelease }}
#         files: packages/*.nupkg
#         generate_release_notes: true
#       env:
#         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
